<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주간 성경 공과 모음</title> <link rel="stylesheet" href="style.css">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4ZNLXJ9BR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Z4ZNLXJ9BR');
</head>
<body>
    <button id="menuToggleButton" class="menu-toggle-button">☰</button>
    <div class="overlay"></div>

    <nav id="sidebarMenu" class="sidebar-menu">
        <h3>목록</h3>
        <ul id="archiveLinks">
            </ul>
    </nav>

    <div id="mainContentWrapper" class="main-content-wrapper">
        <div class="container">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="최신 주차 내용에서 검색..." id="searchInput">
            </div>

            <main id="latestWeekContentContainer" class="page-specific-content">
                <p style="text-align:center; padding: 50px 0; color: #777;">최신 주차 내용을 불러오는 중입니다...</p>
            </main>
            <footer class="footer">
                <p>📚 공과 공부에 도움이 되길 바랍니다 🙏</p>
            </footer>
        </div> 
    </div>

    <script src="menuData.js"></script> 
    <script>
        const menuToggleButton = document.getElementById('menuToggleButton');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const overlay = document.querySelector('.overlay');
        const searchInput = document.getElementById('searchInput');
        const archiveLinksUl = document.getElementById('archiveLinks');
        const contentContainer = document.getElementById('latestWeekContentContainer');
        const pageTitleElement = document.querySelector('head title');

        // --- 메뉴 생성 함수 ---
        function generateSidebarMenu() {
            if (typeof weeklyBibleStudies !== 'undefined' && weeklyBibleStudies.length > 0) {
                archiveLinksUl.innerHTML = ''; // 기존 메뉴 초기화
                const studiesToDisplay = [...weeklyBibleStudies]; // 원본 유지를 위해 복사 (필요시 정렬)
                // 예: studiesToDisplay.sort((a,b) => new Date(b.date) - new Date(a.date)); // 최신순 정렬

                studiesToDisplay.forEach((study, index) => {
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = study.file; 
                    link.innerHTML = `<span class="title">${study.title}</span><span class="date">${study.date} - <i>${study.number}</i></span>`;
                    
                    const currentPath = window.location.pathname;
                    const currentFile = currentPath.substring(currentPath.lastIndexOf('/') + 1);

                    // index.html이고, 현재 study가 배열의 첫번째 (최신) 항목이거나,
                    // 또는 현재 파일명이 study.file과 일치하면 active
                    if (((currentFile === '' || currentFile === 'index.html') && index === 0) || currentFile === study.file) {
                        link.classList.add('active-page-link');
                    }

                    listItem.appendChild(link);
                    archiveLinksUl.appendChild(listItem);
                });
            } else {
                archiveLinksUl.innerHTML = '<li>메뉴 데이터가 없습니다.</li>';
            }
        }

        // --- 구절 클릭 이벤트 리스너 부착 함수 ---
        function attachVerseClickListeners(selector) {
            document.querySelectorAll(selector).forEach(verse => {
                if (verse.dataset.listenerAttached === 'true') return;
                verse.addEventListener('click', function() {
                    this.style.transform = 'scale(1.015)'; 
                    setTimeout(() => { this.style.transform = 'scale(1)'; }, 150); 
                });
                verse.dataset.listenerAttached = 'true';
            });
        }

        // --- 최신 주차 내용 동적 로드 함수 (index.html 에서만 실행되도록 설계) ---
        function loadLatestWeekContent() {
            const currentPageFilename = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);
            // index.html 이거나 루트 경로일 때만 실행
            if (currentPageFilename === 'index.html' || currentPageFilename === '') {
                if (typeof weeklyBibleStudies !== 'undefined' && weeklyBibleStudies.length > 0) {
                    const latestStudy = weeklyBibleStudies[0]; // menuData.js에서 첫 번째 항목이 최신

                    if (latestStudy && latestStudy.file && contentContainer) {
                        fetch(latestStudy.file)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status} for ${latestStudy.file}`);
                                }
                                return response.text();
                            })
                            .then(htmlText => {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(htmlText, 'text/html');
                                const specificContent = doc.querySelector('.page-specific-content');
                                
                                if (specificContent) {
                                    contentContainer.innerHTML = specificContent.innerHTML;
                                    // 페이지 타이틀도 최신 주차 제목으로 업데이트
                                    const loadedTitle = contentContainer.querySelector('.course-title');
                                    if (loadedTitle && pageTitleElement) {
                                        pageTitleElement.textContent = `${latestStudy.number}: ${loadedTitle.textContent.trim()} - 성경 공과`;
                                    }
                                    // 동적으로 로드된 .verse 요소들에 클릭 이벤트 리스너 다시 바인딩
                                    attachVerseClickListeners('#latestWeekContentContainer .verse');
                                } else {
                                    contentContainer.innerHTML = `<p style="text-align:center; color:red;">최신 내용을 불러오는 데 실패했습니다. '${latestStudy.file}' 파일에 '.page-specific-content' 영역이 있는지 확인해주세요.</p>`;
                                }
                            })
                            .catch(error => {
                                console.error('최신 내용 로드 중 오류:', error);
                                contentContainer.innerHTML = `<p style="text-align:center; color:red;">최신 내용을 불러오는 중 오류가 발생했습니다. 개발자 콘솔을 확인해주세요. (${error})</p>`;
                            });
                    } else {
                         contentContainer.innerHTML = '<p style="text-align:center; color:red;">최신 주차 정보를 찾을 수 없습니다. menuData.js를 확인해주세요.</p>';
                    }
                } else {
                    contentContainer.innerHTML = '<p style="text-align:center; color:red;">메뉴 데이터를 불러올 수 없습니다. menuData.js를 확인해주세요.</p>';
                }
            } else {
                // index.html이 아닌 다른 페이지에서는 이미 .page-specific-content 가 있으므로, 해당 요소의 verse에만 리스너 부착
                 attachVerseClickListeners('.page-specific-content .verse');
            }
        }

        // --- 검색 기능 ---
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            let questionGroups;
            const currentPageFilenameForSearch = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);

            if (currentPageFilenameForSearch === 'index.html' || currentPageFilenameForSearch === '') {
                questionGroups = document.querySelectorAll('#latestWeekContentContainer .question-group');
            } else {
                questionGroups = document.querySelectorAll('.page-specific-content .question-group');
            }
            
            let matchFound = false;
            questionGroups.forEach(group => {
                const groupText = group.textContent.toLowerCase();
                if (groupText.includes(searchTerm)) {
                    group.style.display = 'block'; 
                    group.style.background = searchTerm ? 'linear-gradient(135deg, #fff5e1 0%, #ffeccf 100%)' : 'linear-gradient(135deg, #fdfbf7 0%, #f7f2ec 100%)';
                    matchFound = true;
                } else {
                    group.style.display = 'none'; 
                    group.style.background = 'linear-gradient(135deg, #fdfbf7 0%, #f7f2ec 100%)';
                }
            });
            // 검색 결과 없을 때 메시지 (선택 사항)
            // if (!matchFound && searchTerm) { ... }
        });

        // --- 초기화 함수 실행 ---
        generateSidebarMenu(); // 메뉴 생성
        loadLatestWeekContent(); // index.html일 경우 최신 내용 로드, 아니면 기존 verse 리스너 부착

        // 메뉴 토글 및 오버레이
        menuToggleButton.addEventListener('click', function() {
            sidebarMenu.classList.toggle('open');
            overlay.classList.toggle('active');
        });
        overlay.addEventListener('click', function() { 
            sidebarMenu.classList.remove('open');
            overlay.classList.remove('active');
        });

    </script>
</body>
</html>
